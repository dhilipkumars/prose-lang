services:
  # ===== M1: Container Management =====
  m1-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: containerdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - m1-pgdata:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5

  m1:
    build: ./m1
    environment:
      DB_HOST: m1-db
      DB_PORT: 5432
      DB_NAME: containerdb
      DB_USER: postgres
      DB_PASS: postgres
      SERVER_PORT: 8081
    ports:
      - "8081:8081"
    depends_on:
      m1-db:
        condition: service_healthy

  # ===== M2: Product Management =====
  m2-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: productdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - m2-pgdata:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5

  m2:
    build: ./m2
    environment:
      DB_HOST: m2-db
      DB_PORT: 5432
      DB_NAME: productdb
      DB_USER: postgres
      DB_PASS: postgres
      SERVER_PORT: 8082
    ports:
      - "8082:8082"
    depends_on:
      m2-db:
        condition: service_healthy

  # ===== UI: React Frontend =====
  ui:
    build: ./ui
    ports:
      - "3000:3000"
    depends_on:
      - m1
      - m2

volumes:
  m1-pgdata:
  m2-pgdata:
